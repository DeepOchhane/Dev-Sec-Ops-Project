name: Secure CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  secure-pipeline:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Install Trivy
      run: |
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

    # üõ°Ô∏è Scan docker-compose.yaml
    - name: Scan docker-compose.yaml
      run: trivy config ./docker-compose.yaml --severity CRITICAL,HIGH

    # üê≥ Scan Dockerfile
    - name: Scan Dockerfile
      run: trivy config ./backend/Dockerfile --severity CRITICAL,HIGH

    - name: Create .env for backend
      run: echo "MONGO_URI=${{ secrets.MONGO_URI }}" > ./backend/.env

    - name: Build and Start containers
      run: docker compose up --build -d

    # üîç Image scan backend
    - name: Scan Backend Image
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: newsletter-webapp-backend:latest
        format: table
        exit-code: 1
        severity: CRITICAL,HIGH
        ignore-unfixed: true

    # üîç Image scan frontend
    - name: Scan Frontend Image
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: newsletter-webapp-frontend:latest
        format: table
        exit-code: 1
        severity: CRITICAL,HIGH
        ignore-unfixed: true

    # - name: Stop containers
    #   if: always()
    #   run: docker compose down
